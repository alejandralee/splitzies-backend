openapi: 3.0.3
info:
  title: Splitzies API
  description: API for splitting receipts and assigning items to users
  version: 1.0.0
  contact:
    name: Splitzies

servers:
  - url: http://localhost:8080
    description: Local development server
  - url: /
    description: Current host (for Swagger UI "Try it out")

paths:
  /receipts/image:
    post:
      summary: Upload receipt image
      description: |
        Upload a receipt image for OCR processing. The image is stored in GCS, 
        OCR is performed to extract text, and items are parsed using AI (Gemini).
        Returns the receipt ID, image URL, and parsed items.
      operationId: uploadReceiptImage
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - image
              properties:
                image:
                  type: string
                  format: binary
                  description: Receipt image file (JPEG, PNG, GIF, or WebP, max 10MB)
      responses:
        '201':
          description: Receipt image uploaded and processed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UploadReceiptImageResponse'
        '400':
          description: Invalid request (missing image, invalid file type, file too large)
          content:
            text/plain:
              schema:
                type: string
                example: "validation error: image - failed to get image file"
        '405':
          description: Method not allowed
        '500':
          description: Internal server error

  /receipts/{receipt_id}:
    get:
      summary: Get receipt with bill split data
      description: |
        Returns the full receipt with users, items, and assignments (user-item correlation).
        The assignments array links users to items for building the bill split UI - each
        assignment has user_id, item_id, and amount_owed (computed as equal split among assignees).
      operationId: getReceipt
      parameters:
        - name: receipt_id
          in: path
          required: true
          schema:
            type: string
          description: The receipt ID
      responses:
        '200':
          description: Receipt with users, items, and assignments
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetReceiptResponse'
        '404':
          description: Receipt not found
          content:
            text/plain:
              schema:
                type: string
        '405':
          description: Method not allowed
        '500':
          description: Internal server error
    patch:
      summary: Update receipt tax and tip
      description: |
        Update tax and/or tip on a receipt. Use when values were not parsed from the receipt
        during upload. Only provided fields are updated.
      operationId: patchReceipt
      parameters:
        - name: receipt_id
          in: path
          required: true
          schema:
            type: string
          description: The receipt ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PatchReceiptRequest'
      responses:
        '200':
          description: Receipt updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Receipt updated successfully"
        '400':
          description: Invalid request (body must include at least one of tax or tip)
          content:
            text/plain:
              schema:
                type: string
        '404':
          description: Receipt not found
          content:
            text/plain:
              schema:
                type: string
        '405':
          description: Method not allowed
        '500':
          description: Internal server error

  /receipts/{receipt_id}/users:
    get:
      summary: Get users for receipt
      description: List all users/participants associated with a receipt.
      operationId: getReceiptUsers
      parameters:
        - name: receipt_id
          in: path
          required: true
          schema:
            type: string
          description: The receipt ID
      responses:
        '200':
          description: List of users
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetReceiptUsersResponse'
        '404':
          description: Receipt not found
          content:
            text/plain:
              schema:
                type: string
        '405':
          description: Method not allowed
        '500':
          description: Internal server error
    post:
      summary: Add user to receipt
      description: Add a user/participant to a receipt for splitting items.
      operationId: addUserToReceipt
      parameters:
        - name: receipt_id
          in: path
          required: true
          schema:
            type: string
          description: The receipt ID from the upload response
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AddUserToReceiptRequest'
      responses:
        '201':
          description: User added successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AddUserToReceiptResponse'
        '400':
          description: Invalid request (missing name, invalid path)
          content:
            text/plain:
              schema:
                type: string
        '404':
          description: Receipt not found
          content:
            text/plain:
              schema:
                type: string
        '405':
          description: Method not allowed
        '500':
          description: Internal server error

  /receipts/{receipt_id}/items:
    get:
      summary: Get items for receipt
      description: List all items on a receipt.
      operationId: getReceiptItems
      parameters:
        - name: receipt_id
          in: path
          required: true
          schema:
            type: string
          description: The receipt ID
      responses:
        '200':
          description: List of receipt items
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetReceiptItemsResponse'
        '404':
          description: Receipt not found
          content:
            text/plain:
              schema:
                type: string
        '405':
          description: Method not allowed
        '500':
          description: Internal server error

  /receipts/{receipt_id}/users/{user_id}/items:
    post:
      summary: Assign items to user
      description: |
        Assign receipt items to a user. Amount owed is computed as equal split among
        all users assigned to each item (see GET receipt for computed amounts).
      operationId: assignItemsToUser
      parameters:
        - name: receipt_id
          in: path
          required: true
          schema:
            type: string
          description: The receipt ID
        - name: user_id
          in: path
          required: true
          schema:
            type: string
          description: The receipt user ID (from add user response)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AssignItemsToUserRequest'
      responses:
        '201':
          description: Items assigned successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AssignItemsToUserResponse'
        '400':
          description: Invalid request (empty item_ids, invalid path)
          content:
            text/plain:
              schema:
                type: string
        '404':
          description: User or item not found
          content:
            text/plain:
              schema:
                type: string
        '405':
          description: Method not allowed
        '500':
          description: Internal server error

components:
  schemas:
    ReceiptItem:
      type: object
      properties:
        id:
          type: string
          description: Unique item ID
        name:
          type: string
          description: Item name
        quantity:
          type: integer
          description: Item quantity
        total_price:
          type: number
          format: double
          nullable: true
          description: Total price for this item
        price_per_item:
          type: number
          format: double
          nullable: true
          description: Price per unit

    UploadReceiptImageResponse:
      type: object
      properties:
        message:
          type: string
          example: "Receipt image uploaded successfully with ID: rcpt_abc123"
        receipt_id:
          type: string
          description: Unique receipt ID for subsequent API calls
        image_url:
          type: string
          format: uri
          description: URL of the uploaded image in GCS
        items:
          type: array
          items:
            $ref: '#/components/schemas/ReceiptItem'
          description: Parsed items from OCR/AI
        ocr_text:
          type: string
          description: Raw OCR text (when available, for debugging)
        tax:
          type: number
          format: double
          description: Tax amount parsed from receipt (when detected)
        tip:
          type: number
          format: double
          description: Tip amount parsed from receipt (when detected)

    AddUserToReceiptRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          description: User/participant name
          example: "John Doe"

    AddUserToReceiptResponse:
      type: object
      properties:
        message:
          type: string
          example: "User added to receipt successfully"
        user:
          type: object
          properties:
            id:
              type: string
              description: Receipt user ID (use for assignment)
            receipt_id:
              type: string
            name:
              type: string

    AssignItemsToUserRequest:
      type: object
      required:
        - item_ids
      properties:
        item_ids:
          type: array
          items:
            type: string
          description: Receipt item IDs to assign to this user
          minItems: 1
          example: ["item_abc123", "item_def456"]

    AssignItemsToUserResponse:
      type: object
      properties:
        message:
          type: string
          example: "Successfully assigned 2 item(s) to user"
        items:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
                description: Assignment ID
              receipt_user_id:
                type: string
              receipt_item_id:
                type: string

    GetReceiptResponse:
      type: object
      description: Full receipt with users, items, and user-item assignments for bill split
      properties:
        receipt_id:
          type: string
          description: Receipt ID
        users:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
                description: Receipt user ID
              receipt_id:
                type: string
              name:
                type: string
              user_total:
                type: number
                format: double
                description: Sum of amount_owed for all items assigned to this user
        items:
          type: array
          items:
            $ref: '#/components/schemas/ReceiptItem'
        assignments:
          type: array
          description: User-item correlation for bill split. amount_owed is computed as equal split among all users assigned to each item, rounded to whole cents.
          items:
            type: object
            properties:
              id:
                type: string
                description: Assignment ID
              user_id:
                type: string
                description: Receipt user ID
              item_id:
                type: string
                description: Receipt item ID
              amount_owed:
                type: number
                format: double
                description: Amount this user owes for this item (equal split among assignees, whole cents)

    GetReceiptUsersResponse:
      type: object
      properties:
        users:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              receipt_id:
                type: string
              name:
                type: string

    GetReceiptItemsResponse:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/ReceiptItem'

    PatchReceiptRequest:
      type: object
      description: Update tax and/or tip (only provided fields are updated)
      minProperties: 1
      properties:
        tax:
          type: number
          format: double
          nullable: true
          description: Sales tax amount
        tip:
          type: number
          format: double
          nullable: true
          description: Tip/gratuity amount
